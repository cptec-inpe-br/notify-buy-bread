<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Pão</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center gap-4 m-4">
 <div class="flex flex-col gap-8">
     <div class="flex flex-col gap-4">
       <div class="flex gap-4">
       <button
      id="btn-send-emails"
      class="bg-green-600 hover:bg-green-700 text-white font-bold items-center h-14 mt-6 rounded w-full"
    >
      Avisar quem traz o pão
    </button>

    <button
      id="btn-create-balanced-dates"
      class="bg-purple-600 hover:bg-purple-700 text-white font-bold items-center rounded w-full h-14 mt-6"
    >
      Criar datas balanceadas
    </button>

    <button
      id="btn-delete-all-dates"
      class="bg-red-600 hover:bg-red-700 text-white font-bold items-center rounded w-full h-14 mt-6"
    >
      Deletar todas as datas
    </button>
    
    <button
      id="btn-send-coffee-reminder"
      class="bg-blue-600 hover:bg-blue-700 text-white font-bold items-center rounded w-full h-14 mt-6"
    >
      Enviar Lembrete de Café
    </button>
     </div>


    <!-- Formulário de Usuário -->
    <div class="bg-white py-6 rounded shadow">
      <div class="p-6">
      <h2 class="text-xl font-semibold mb-4">Cadastrar Usuário</h2>
      <form id="user-form" class="space-y-4">
        <input type="text" id="user-name" placeholder="Nome" required class="w-full p-2 border rounded" />
        <input type="email" id="user-email" placeholder="Email" required class="w-full p-2 border rounded" />
        <select id="user-dias-responsavel" required class="w-full p-2 border rounded">
          <option value="">Selecione os dias que o usuário pode levar</option>
        </select>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 w-full">Cadastrar</button>
      </form>
      </div>

        <!-- Formulário de Datas -->
        <div class="p-6">
          <h2 class="text-xl font-semibold mb-4">Cadastrar Data</h2>
          <form id="date-form" class="space-y-4">
            <input type="date" id="date-input" required class="w-full p-2 border rounded" />
            <select id="user-select" required class="w-full p-2 border rounded">
              <option value="">Selecione um usuário</option>
            </select>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 w-full">Cadastrar</button>
          </form>
        </div>
      </div>
    </div>
     </div>

    <!-- Lista de Datas -->
 <div class="flex-1 space-y-4">
      <div class="max-h-[20.5rem] overflow-auto mt-6 rounded border">
<div class="bg-white p-6 rounded shadow">
  <div class="flex justify-between items-center">
    <h2 class="text-xl font-semibold mb-4">Próximas Datas</h2>
  <button id="btnAtualizarDatas" title="Recarregar" class="p-2 rounded hover:bg-gray-200 flex items-center gap-2">Recarregar
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6" viewBox="0 0 24 24">
          <path d="M1 4v6h6"/>
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
        </svg>
      </button>
  </div>
    <table class="w-full table-auto border text-sm">
      <thead class="sticky top-0 bg-white">

        <tr class="bg-gray-100">
          <th class="px-4 py-2 text-left">Data</th>
          <th class="px-4 py-2 text-left">Responsável</th>
          <th class="px-4 py-2 text-left">Ações</th>
        </tr>
      </thead>
      <tbody id="dates-list"></tbody>
    </table>
  </div>
      </div>
<!-- Adicione essa seção onde quiser no HTML -->
    <div class="max-h-[20.5rem] overflow-auto rounded border">
<div class="bg-white p-6 rounded shadow">
  <div class="flex justify-between items-center">
  <h2 class="text-xl font-semibold mb-4">Usuários Cadastrados</h2>
  <button id="btnAtualizarUsers" title="Recarregar" class="p-2 rounded hover:bg-gray-200 flex items-center gap-2">Recarregar
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6" viewBox="0 0 24 24">
          <path d="M1 4v6h6"/>
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
        </svg>
      </button>
    </div>
  <table class="w-full table-auto border text-sm">
    <thead>
      <tr class="bg-gray-100">
        <th class="px-4 py-2 text-left">Nome</th>
        <th class="px-4 py-2 text-left">Email</th>
        <th class="px-4 py-2 text-left">Dias Responsável</th>
        <th class="px-4 py-2 text-center">Ações</th>
      </tr>
    </thead>
    <tbody id="users-list"></tbody>
  </table>
</div>
    </div>
    </div>
  

  <!-- Modal de edição de data -->
<div id="edit-date-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h3 class="text-lg font-bold mb-4">Editar Data</h3>
    <form id="edit-date-form" class="space-y-4">
      <div>
        <label for="edit-date-input" class="block text-sm font-medium text-gray-700">Data</label>
        <input type="date" id="edit-date-input" class="w-full p-2 border rounded" required />
      </div>
      <div>
        <label for="edit-date-user" class="block text-sm font-medium text-gray-700">Responsável</label>
        <select id="edit-date-user" class="w-full p-2 border rounded" required></select>
      </div>
      <div class="flex justify-between mt-2">
        <button type="button" id="btn-notify-user" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Notificar Usuário</button>
        <div class="flex space-x-4">
          <button type="button" id="cancel-edit-date-btn" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button>
        </div>
      </div>
      <p id="edit-date-warning" class="text-red-600 mt-2 hidden">Esta data já foi avisada e não pode ser alterada.</p>
    </form>
  </div>
</div>
<!-- Modal simples para edição -->

<div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h3 class="text-lg font-bold mb-4">Editar Usuário</h3>
    <form id="edit-user-form" class="space-y-4">
      <input type="text" id="edit-user-name" placeholder="Nome" required class="w-full p-2 border rounded" />
      <input type="email" id="edit-user-email" placeholder="Email" required class="w-full p-2 border rounded" />
      <select id="edit-user-dias" class="w-full p-2 border rounded" required></select>
      <div class="flex justify-end space-x-4">
        <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button>
      </div>
    </form>
  </div>
</div>
 <div id="coffee-reminder-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h3 class="text-lg font-bold mb-4">Enviar Lembrete de Café</h3>
    <form id="coffee-reminder-form" class="space-y-4">
      <div>
        <label for="coffee-subject" class="block text-sm font-medium text-gray-700">Assunto</label>
        <input type="text" id="coffee-subject" value="Tá na hora do cafezinho" class="w-full p-2 border rounded">
      </div>
      <div>
        <label for="coffee-message" class="block text-sm font-medium text-gray-700">Mensagem</label>
        <textarea id="coffee-message" rows="4" class="w-full p-2 border rounded" placeholder="Digite sua mensagem aqui..."></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" id="btn-cancel-coffee-reminder" class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300">
          Cancelar
        </button>
        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded hover:bg-blue-700">
          Enviar
        </button>
      </div>
    </form>
  </div>
</div>

  <script>
    const API = "http://localhost:8000"; // ajuste conforme necessário

    async function loadUsers() {
      const res = await fetch(`${API}/users/`);
      const users = await res.json();
      const select = document.getElementById("user-select");
      select.innerHTML = `<option value="">Selecione um usuário</option>`;
      users.forEach(user => {
        const option = document.createElement("option");
        option.value = user.id;
        option.textContent = `${user.nome} (${user.email})`;
        select.appendChild(option);
      });
    }

    async function loadDates() {
      const res = await fetch(`${API}/dates/`);
      const dates = await res.json();
      const list = document.getElementById("dates-list");
      list.innerHTML = "";

      dates.forEach((item) => {
        const tr = document.createElement("tr");

        const [year, month, day] = item.data.split("-");
        const dataFormatada = `${day}/${month}/${year}`;

        tr.innerHTML = `
          <td class="px-4 py-2 border">${dataFormatada}</td>
          <td class="px-4 py-2 border">
            ${item.user.nome}
            ${item.foi_avisado ? `<span class="text-green-600 font-semibold ml-2">(Avisado)</span>` : ""}
          </td>
          <td class="px-4 py-2 border text-center">
            <button onclick="openEditDateModal(${item.id}, '${item.data}', ${item.user.id}, ${item.foi_avisado})"
              class="text-blue-600 hover:text-blue-800 font-bold">✏️</button>
            <button onclick="deleteDate(${item.id})"
                    class="text-red-600 hover:text-red-800 font-bold">❌</button>
          </td>
        `;
        list.appendChild(tr);
      });
    }

    async function loadDiasResponsavel() {
      try {
        const res = await fetch(`${API}/users/dias/`);
        if (!res.ok) throw new Error('Falha ao buscar dias responsavel');
        const options = await res.json();

        const select = document.getElementById("user-dias-responsavel");
        select.innerHTML = `<option value="">Selecione os dias que o usuário pode levar</option>`;

        options.forEach(opt => {
          const label = opt.replace('_', ' & ').replace(/\b\w/g, c => c.toUpperCase()); // "terca_quinta" => "Terca & Quinta"
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = label;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Erro ao carregar dias responsavel:", err);
      }
    }

    async function deleteDate(id) {
      if (!confirm("Tem certeza que deseja deletar essa data?")) return;
      const res = await fetch(`${API}/dates/${id}`, { method: "DELETE" });
      if (res.ok) {
        loadDates();
      } else {
        alert("Erro ao deletar.");
      }
    }

    document.getElementById("user-form").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("user-name").value;
      const email = document.getElementById("user-email").value;
      const diasResponsavel = document.getElementById("user-dias-responsavel").value;
      
      if (!diasResponsavel) {
        alert("Por favor, selecione os dias de responsabilidade.");
        return;
      }
      
      try {
        const response = await fetch(`${API}/users/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            nome: name, 
            email: email, 
            dias_responsavel: diasResponsavel // Adicionando o campo dias_responsavel
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Erro ao cadastrar usuário');
        }
        
        // Atualiza as listas após o cadastro
        await Promise.all([
          loadUsers(),
          loadUsersList()
        ]);
        
        // Mostra mensagem de sucesso
        alert("Usuário cadastrado com sucesso!");
        e.target.reset();
        
      } catch (error) {
        console.error("Erro ao cadastrar usuário:", error);
        alert(`Erro ao cadastrar usuário: ${error.message}`);
      }
    });

    document.getElementById("btn-send-emails").addEventListener("click", async () => {
      try {
        const response = await fetch(`${API}/mails/send-emails-alert/`, {
          method: "POST",
        });

        if (!response.ok) {
          throw new Error("Falha ao enviar e-mails.");
        }

        const data = await response.json();
        alert(data.message || "E-mails enviados com sucesso!");
        loadDates();
      } catch (err) {
        console.error("Erro ao enviar e-mails:", err);
        alert("Erro ao enviar os e-mails.");
      }
    });

    document.getElementById("date-form").addEventListener("submit", async e => {
      e.preventDefault();
      const data = document.getElementById("date-input").value;
      console.log(data)
      const user_id = parseInt(document.getElementById("user-select").value);
      if (!user_id) return alert("Selecione um usuário!");
      await fetch(`${API}/dates/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: data, user_id: user_id })
      });
      await loadDates();
      e.target.reset();
    });

     document.getElementById("btn-create-balanced-dates").addEventListener("click", async () => {
        try {
          if (!confirm("Tem certeza que deseja realizar essa operação? Datas podem ser sobrescritas.")) return;          
          const response = await fetch(`${API}/dates/create-balanced-dates/`, {
            method: "POST",
          });

          if (!response.ok) {
            throw new Error("Falha ao criar datas balanceadas.");
          }

          const data = await response.json();
          alert(data.message || "Datas criadas com sucesso!");
          loadDates(); // Atualiza a lista de datas
        } catch (err) {
          console.error("Erro ao criar datas balanceadas:", err);
          alert("Erro ao criar datas balanceadas.");
        }
      });

      document.getElementById("btn-delete-all-dates").addEventListener("click", async () => {
      if (!confirm("Tem certeza que deseja deletar todas as datas?")) return;
      try {
        const res = await fetch(`${API}/dates/`, { method: "DELETE" });
        if (res.ok) {
          alert("Todas as datas foram deletadas.");
          loadDates();
        } else {
          alert("Erro ao deletar as datas.");
        }
      } catch (err) {
        console.error(err);
        alert("Erro ao deletar as datas.");
      }
    });

    const usersListEl = document.getElementById("users-list");
  const editModal = document.getElementById("edit-user-modal");
  const editForm = document.getElementById("edit-user-form");
  const editNameInput = document.getElementById("edit-user-name");
  const editEmailInput = document.getElementById("edit-user-email");
  const editDiasSelect = document.getElementById("edit-user-dias");
  const cancelEditBtn = document.getElementById("cancel-edit-btn");

  let currentEditUserId = null;
  let diasEnumOptions = [];

  async function loadDiasEnum() {
    const res = await fetch(`${API}/users/dias/`);
    diasEnumOptions = await res.json();

    editDiasSelect.innerHTML = diasEnumOptions
      .map(opt => `<option value="${opt}">${opt.replace('_', ' ').toUpperCase()}</option>`)
      .join("");
  }

  async function loadUsersList() {
    const res = await fetch(`${API}/users/`);
    const users = await res.json();
    usersListEl.innerHTML = "";
    users.forEach(user => {
      usersListEl.innerHTML += `
        <tr>
          <td class="px-4 py-2 border">${user.nome}</td>
          <td class="px-4 py-2 border">${user.email}</td>
          <td class="px-4 py-2 border">${user.dias_responsavel || ''}</td>
          <td class="px-4 py-2 border text-center space-x-2">
            <button onclick="openEditModal(${user.id})" class="text-blue-600 hover:text-blue-800 font-bold">✏️</button>
            <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800 font-bold">❌</button>
          </td>
        </tr>`;
    });
  }

  function openEditModal(userId) {
    currentEditUserId = userId;
    fetch(`${API}/users/${userId}`)
      .then(res => res.json())
      .then(user => {
        editNameInput.value = user.nome;
        editEmailInput.value = user.email;
        editDiasSelect.value = user.dias_responsavel || diasEnumOptions[0];
        editModal.classList.remove("hidden");
      });
  }

  cancelEditBtn.onclick = () => {
    editModal.classList.add("hidden");
    currentEditUserId = null;
  };

  editForm.onsubmit = async e => {
    e.preventDefault();
    if (!currentEditUserId) return;

    const updatedUser = {
      nome: editNameInput.value.trim(),
      email: editEmailInput.value.trim(),
      dias_responsavel: editDiasSelect.value,
    };

    const res = await fetch(`${API}/users/${currentEditUserId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updatedUser),
    });

    if (res.ok) {
      alert("Usuário atualizado!");
      editModal.classList.add("hidden");
      currentEditUserId = null;
      loadUsersList();
      loadUsers(); // para atualizar o select também
    } else {
      const errorData = await res.json();
      alert(`Erro: ${errorData.detail || "Não foi possível atualizar."}`);
    }
  };

  async function deleteUser(userId) {
    if (!confirm("Tem certeza que deseja deletar este usuário?")) return;
    const res = await fetch(`${API}/users/${userId}`, { method: "DELETE" });
    if (res.ok) {
      alert("Usuário deletado!");
      loadUsersList();
      loadUsers();
      loadDates(); // para remover datas associadas
    } else {
      alert("Erro ao deletar usuário.");
    }
  }
  document.getElementById("btnAtualizarDatas").addEventListener("click", () => {
    loadDates();
  });

  document.getElementById("btnAtualizarUsers").addEventListener("click", () => {
    loadUsersList();
  });

  // Funções para o modal de envio de lembretes de café
  const coffeeReminderModal = document.getElementById('coffee-reminder-modal');
  const coffeeReminderForm = document.getElementById('coffee-reminder-form');
  const btnCancelCoffeeReminder = document.getElementById('btn-cancel-coffee-reminder');

  // Abrir modal de lembrete de café
  document.getElementById('btn-send-coffee-reminder').addEventListener('click', () => {
    coffeeReminderModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });

  // Fechar modal ao clicar no botão cancelar
  btnCancelCoffeeReminder.addEventListener('click', () => {
    coffeeReminderModal.classList.add('hidden');
    document.body.style.overflow = '';
  });

  // Fechar modal ao clicar fora do conteúdo
  coffeeReminderModal.addEventListener('click', (e) => {
    if (e.target === coffeeReminderModal) {
      coffeeReminderModal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  });

  // Enviar lembretes de café
  coffeeReminderForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const subject = document.getElementById('coffee-subject').value.trim();
    const message = document.getElementById('coffee-message').value.trim();
    
    // Validação básica
    if (!subject) {
      alert('Por favor, insira um assunto para o lembrete.');
      return;
    }
    
    const btnSubmit = coffeeReminderForm.querySelector('button[type="submit"]');
    const originalBtnText = btnSubmit.textContent;
    
    try {
      // Desabilitar botão e mostrar loading
      btnSubmit.disabled = true;
      btnSubmit.innerHTML = '<span class="inline-flex items-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Enviando...</span>';
      
      const response = await fetch(`${API}/mails/time-to-coffee`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          subject,
          message: message || undefined
        }),
      });
      
      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.detail || 'Não foi possível enviar os lembretes. Tente novamente mais tarde.');
      }
      
      const result = await response.json();
      
      // Feedback visual de sucesso
      const successMessage = document.createElement('div');
      successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg';
      successMessage.textContent = result.message || 'Lembretes enviados com sucesso!';
      document.body.appendChild(successMessage);
      
      // Fechar o modal e limpar o formulário
      coffeeReminderModal.classList.add('hidden');
      document.body.style.overflow = '';
      coffeeReminderForm.reset();
      
      // Remover mensagem após 3 segundos
      setTimeout(() => {
        successMessage.remove();
      }, 3000);
      
    } catch (error) {
      console.error('Erro ao enviar lembretes:', error);
      
      // Feedback visual de erro
      const errorMessage = document.createElement('div');
      errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg';
      errorMessage.textContent = `Erro: ${error.message}`;
      document.body.appendChild(errorMessage);
      
      // Remover mensagem após 5 segundos
      setTimeout(() => {
        errorMessage.remove();
      }, 5000);
      
    } finally {
      // Reativar o botão
      btnSubmit.disabled = false;
      btnSubmit.innerHTML = originalBtnText;
    }
  });

  // Inicializa enum + lista
    loadDiasEnum().then(loadUsersList);

    // Inicialização
    loadUsers();
    loadDates();
    loadDiasResponsavel();
  </script>
  <script>
let currentEditDateId = null;
const editDateModal = document.getElementById('edit-date-modal');
const editDateForm = document.getElementById('edit-date-form');
const editDateInput = document.getElementById('edit-date-input');
const editDateUser = document.getElementById('edit-date-user');
const cancelEditDateBtn = document.getElementById('cancel-edit-date-btn');
const editDateWarning = document.getElementById('edit-date-warning');
const btnNotifyUser = document.getElementById('btn-notify-user');

function openEditDateModal(id, date, userId, foiAvisado) {
  currentEditDateId = id;
  editDateInput.value = date;
  editDateUser.innerHTML = document.getElementById('user-select').innerHTML; // reutiliza select de usuários
  editDateUser.value = userId;

  if (foiAvisado) {
    editDateInput.disabled = true;
    editDateUser.disabled = true;
    editDateWarning.classList.remove('hidden');
  } else {
    editDateInput.disabled = false;
    editDateUser.disabled = false;
    editDateWarning.classList.add('hidden');
  }

  editDateModal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

cancelEditDateBtn.onclick = () => {
  editDateModal.classList.add('hidden');
  document.body.style.overflow = '';
  currentEditDateId = null;
};

editDateForm.onsubmit = async e => {
  e.preventDefault();
  if (!currentEditDateId) return;

  const updatedDate = {
    data: editDateInput.value,
    user_id: parseInt(editDateUser.value)
  };

  const res = await fetch(`${API}/dates/${currentEditDateId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(updatedDate)
  });

  if (res.ok) {
    alert("Data atualizada!");
    editDateModal.classList.add('hidden');
    document.body.style.overflow = '';
    currentEditDateId = null;
    loadDates(); // atualiza lista de datas
  } else {
    const errorData = await res.json();
    alert(`Erro: ${errorData.detail || "Não foi possível atualizar a data."}`);
  }
};

// Notificar apenas o usuário da data
btnNotifyUser.onclick = async () => {
  if (!currentEditDateId) return;

  const res = await fetch(`${API}/mails/notify-user-by-date/${currentEditDateId}`, { method: 'POST' });
  if (res.ok) {
    alert("Usuário notificado!");
    loadDates();
  } else {
    alert("Erro ao notificar usuário.");
  }
};
</script>
</body>
</html>
